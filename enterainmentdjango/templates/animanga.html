{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Anime & Manga</title>
    <link rel="stylesheet" type="text/css" href="{% static 'styles.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Caprasimo&family=League+Spartan:wght@100..900&family=Passion+One:wght@400;700;900&family=Ultra&family=Young+Serif&display=swap" rel="stylesheet">
    <!-- Add Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Alpine.js -->
    <script src="//unpkg.com/alpinejs" defer></script>
    <script src="//unpkg.com/intersection-observer" defer></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>
    <header>
        <div class="header-content" x-data="{ isMenuOpen: false }">
            <div class="title-menu-container">
                <!-- Combined Title and Hamburger Menu -->
                <div class="title-hamburger" @mouseleave="isMenuOpen = false">
                    <h1>Anime & Manga</h1>
                    <div class="hamburger-menu">
                        <input type="checkbox" id="menu-toggle" x-model="isMenuOpen">
                        <!-- Use Font Awesome Icon -->
                        <label for="menu-toggle" class="menu-icon" @click="isMenuOpen = !isMenuOpen">
                            <i class="fas" :class="isMenuOpen ? 'fa-times' : 'fa-bars'"
                               x-transition:enter="menu-enter"
                               x-transition:enter-start="menu-enter-start"
                               x-transition:enter-end="menu-enter-end"></i>
                        </label>
                        <div class="dropdown-menu" 
                             x-show="isMenuOpen"
                             x-transition:enter="menu-enter"
                             x-transition:enter-start="menu-enter-start"
                             x-transition:enter-end="menu-enter-end"
                             x-transition:leave="menu-leave"
                             x-transition:leave-start="menu-leave-start"
                             x-transition:leave-end="menu-leave-end">
                            <ul>
                                <li><a href="{% url 'animanga' %}?category=popular">Popular Anime</a></li>
                                <li><a href="{% url 'animanga' %}?category=top_rated">Top Rated</a></li>
                                <li class="divider"></li>
                                <li>Genres</li>
                                <li><a href="{% url 'animanga' %}?genre=action">Action</a></li>
                                <li><a href="{% url 'animanga' %}?genre=comedy">Comedy</a></li>
                                <li><a href="{% url 'animanga' %}?genre=drama">Drama</a></li>
                                <li><a href="{% url 'animanga' %}?genre=sci-fi">Sci-Fi</a></li>
                                <!-- Add more genres as needed -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <nav>
                <ul>
                    <li><a href="{% url 'account' %}">Create Account / Login</a></li>
                    <li><a href="{% url 'books' %}">Books</a></li>
                    <li><a href="{% url 'shows' %}">Shows</a></li>
                    <li><a href="{% url 'animanga' %}">Anime & Manga</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main x-data="{ 
        searchQuery: '{{ query|default:"" }}',
        isLoading: false,
        currentPage: {{ current_page|default:1 }},
        hasNextPage: {{ has_next|yesno:'true,false' }},

        async handleSearch() {
            if (this.debounceTimeout) clearTimeout(this.debounceTimeout);
            
            this.debounceTimeout = setTimeout(() => {
                this.applyFilters();
            }, 300);
        },

        async applyFilters() {
            const params = new URLSearchParams();
            if (this.searchQuery) params.set('query', this.searchQuery);
            window.location.search = params.toString();
        },

        handleScroll() {
            if ((window.innerHeight + window.scrollY) >= document.documentElement.scrollHeight - 100) {
                if (!this.isLoading && this.hasNextPage) {
                    this.loadMore();
                }
            }
        },

        async loadMore() {
            if (this.isLoading) return;
            const nextPage = this.currentPage + 1;
            this.isLoading = true;
            
            try {
                const response = await fetch(
                    `?page=${nextPage}&query=${this.searchQuery}`
                );
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newAnime = doc.querySelector('.anime-list').innerHTML;
                this.$refs.animeList.insertAdjacentHTML('beforeend', newAnime);
                this.currentPage = nextPage;
                this.hasNextPage = doc.querySelector('main').__x.$data.hasNextPage;
            } catch (error) {
                console.error('Error loading more anime:', error);
            } finally {
                this.isLoading = false;
            }
        }
    }" @scroll.window="handleScroll">
        <div class="searchbar">
            <form @submit.prevent="handleSearch()">
                <input type="text" 
                       x-model="searchQuery" 
                       @input="handleSearch()"
                       placeholder="Search for anime..."
                       :class="{ 'searching': isLoading }">
            </form>
        </div>
        
        <div class="anime-container">
            <template x-if="searchQuery">
                <h1>Search Results for "<span x-text="searchQuery"></span>"</h1>
            </template>
            <template x-if="!searchQuery">
                <h1>Trending Anime</h1>
            </template>

            {% if error %}
                <div class="error-message">{{ error }}</div>
            {% else %}
                <div class="anime-list" x-ref="animeList">
                    {% for anime in animanga_list %}
                        <div class="anime-item">
                            <div class="anime-cover-container">
                                {% if anime.status and anime.format != "MOVIE" %}
                                    <p class="anime-status">{{ anime.status }}</p>
                                {% endif %}
                                <img src="{{ anime.coverImage.large }}"
                                     alt="{{ anime.title.english|default:anime.title.romaji }}"
                                     class="anime-cover">
                            </div>
                            <div class="anime-info">
                                <h2 class="anime-title">{{ anime.title.english|default:anime.title.romaji }}</h2>
                                {% if anime.averageScore %}
                                    <p class="anime-score">Score: {{ anime.averageScore }}%</p>
                                {% endif %}
                                
                                <!-- Updated episode display -->
                                <p class="anime-episodes">
                                    {% if anime.format == "MOVIE" %}
                                    {% else %}
                                        Episode: 
                                        {% if anime.status == "RELEASING" and anime.nextAiringEpisode %}
                                            {{ anime.nextAiringEpisode.episode|add:"-1" }}
                                            {% if anime.episodes %}
                                                /{{ anime.episodes }}
                                            {% endif %}
                                        {% else %}
                                            {{ anime.episodes|default:"?" }}
                                        {% endif %}
                                    {% endif %}
                                </p>
                                                            
      
                                
                                <!-- Genre display -->
                                <div class="anime-genres">
                                    {% for genre in anime.genres|slice:":3" %}
                                        <span class="genre-tag">{{ genre }}</span>
                                    {% endfor %}
                                </div>

                                <!-- More Info button -->
                                <a href="{% url 'anime_detail' anime.id %}" class="more-info-btn">More Info</a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        <div x-show="isLoading" class="loading-indicator">
            <div class="spinner"></div>
            Loading more anime...
        </div>
    </main>
</body>
</html>