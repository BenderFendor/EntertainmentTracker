{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Anime & Manga</title>
    <link rel="stylesheet" type="text/css" href="{% static 'styles.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Caprasimo&family=League+Spartan:wght@100..900&family=Passion+One:wght@400;700;900&family=Ultra&family=Young+Serif&display=swap" rel="stylesheet">
    <!-- Add Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add Alpine.js -->
    <script src="//unpkg.com/alpinejs" defer></script>
    <script src="//unpkg.com/intersection-observer" defer></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- ...existing head content... -->
</head>
<body>
    <header>
        <div class="header-content" x-data="{ isMenuOpen: false }">
            <div class="title-menu-container">
                <div class="title-hamburger" @mouseleave="isMenuOpen = false">
                    <h1>Anime & Manga</h1>
                    <div class="hamburger-menu">
                        <!-- ...existing menu content... -->
                    </div>
                </div>
            </div>
            <nav>
                <ul>
                    <li><a href="{% url 'account' %}">Create Account / Login</a></li>
                    <li><a href="{% url 'books' %}">Books</a></li>
                    <li><a href="{% url 'shows' %}">Shows</a></li>
                    <li><a href="{% url 'animanga' %}">Anime & Manga</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main x-data="{ 
        searchQuery: '{{ query|default:"" }}',
        format: '{{ format|default:"" }}',
        sortBy: '{{ sort|default:"POPULARITY_DESC" }}',
        isLoading: false,
        debounceTimeout: null,
        isSearching: false,

        async applyFilters() {
            const params = new URLSearchParams(window.location.search);
            if (this.searchQuery) params.set('query', this.searchQuery);
            if (this.format) params.set('format', this.format);
            if (this.sortBy) params.set('sort', this.sortBy);
            window.location.search = params.toString();
        },
        handleScroll() {
            if ((window.innerHeight + window.scrollY) >= document.documentElement.scrollHeight - 100) {
                if (!this.isLoading && {{ page_info.hasNextPage|yesno:'true,false' }}) {
                    this.loadMore();
                }
            }
        },
        async loadMore() {
            if (this.isLoading) return;
            
            this.isLoading = true;
            const nextPage = {{ page_info.currentPage }} + 1;
            
            try {
                const response = await fetch(`?page=${nextPage}&query={{ query }}`);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newAnime = doc.querySelector('.anime-list').innerHTML;
                this.$refs.animeList.insertAdjacentHTML('beforeend', newAnime);
            } catch (error) {
                console.error('Error loading more anime:', error);
            } finally {
                this.isLoading = false;
            }
        },
        async searchAnime() {
            if (this.debounceTimeout) clearTimeout(this.debounceTimeout);
            this.debounceTimeout = setTimeout(async () => {
                if (this.searchQuery.length > 2) {
                    this.isSearching = true;
                    const response = await fetch(`?query=${this.searchQuery}`);
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    this.$refs.animeList.innerHTML = doc.querySelector('.anime-list').innerHTML;
                    this.isSearching = false;
                }
            }, 300);
        }
    }"
    @scroll.window="handleScroll">
        <div class="searchbar">
            <form @submit.prevent="searchAnime()">
                <input type="text" 
                       x-model="searchQuery" 
                       @input="searchAnime()"
                       placeholder="Search for anime..."
                       :class="{ 'searching': isSearching }">
                <button type="submit" 
                        :disabled="isSearching"
                        :class="{ 'searching': isSearching }">
                    <i class="fas" :class="isSearching ? 'fa-spinner fa-spin' : 'fa-search'"></i>
                </button>
            </form>
        </div>
        
        <div class="filter-controls">
            <select x-model="format" @change="applyFilters()">
                <option value="">All Formats</option>
                {% for format in filters.formats %}
                <option value="{{ format }}">{{ format }}</option>
                {% endfor %}
            </select>

            <select x-model="sortBy" @change="applyFilters()">
                {% for value, label in filters.sorts %}
                <option value="{{ value }}">{{ label }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="anime-container">
            <h1>{% if query %}Search Results{% else %}Popular Anime{% endif %}</h1>
            
            {% if error %}
                <div class="error-message">{{ error }}</div>
            {% elif not anime_list %}
                <div class="no-results">No anime found</div>
            {% else %}
                <div class="anime-list" x-ref="animeList">
                    {% for anime in anime_list %}
                        <div class="anime-item">
                            <div class="anime-cover-container">
                                <img src="{{ anime.coverImage.large }}"
                                     alt="{{ anime.title.english|default:anime.title.romaji }}"
                                     class="anime-cover">
                            </div>
                            <div class="anime-info">
                                <h2 class="anime-title">{{ anime.title.english|default:anime.title.romaji }}</h2>
                                <p class="anime-score">Score: {{ anime.averageScore|default:"N/A" }}%</p>
                                <p class="anime-episodes">Episodes: {{ anime.episodes|default:"?" }}</p>
                                <div class="anime-genres">
                                    {% for genre in anime.genres|slice:":3" %}
                                        <span class="genre-tag">{{ genre }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        <div x-ref="loadingIndicator" class="loading-indicator" x-show="isLoading">
            <div class="spinner"></div>
            Loading more anime...
        </div>
    </main>

</body>
</html>